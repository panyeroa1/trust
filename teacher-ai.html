<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Generator - Succes Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.88);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-blur: blur(16px);
            --shadow-apple: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fbfbfd;
            height: 100dvh;
            overflow: hidden;
            color: #1d1d1f;
            letter-spacing: -0.022em;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .font-black {
            font-family: "SF Pro Display", "SF Pro Text", -apple-system, sans-serif;
            letter-spacing: -0.02em;
        }

        .glass-apple {
            background: var(--glass-bg);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 0.5px solid var(--glass-border);
            box-shadow: var(--shadow-apple);
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.8);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
        }

        .bottom-lift {
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
        }

        .input-apple {
            background: #f5f5f7;
            border: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .input-apple:focus {
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 125, 250, 0.1);
            outline: none;
        }

        .btn-apple {
            border-radius: 14px;
            font-weight: 510;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .btn-apple:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .animate-slide-up {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .visualizer-bar {
            width: 4px;
            background-color: #3b82f6;
            border-radius: 4px;
            animation: quiet 1s ease-in-out infinite;
        }

        .speaking .visualizer-bar {
            animation: talking 0.5s ease-in-out infinite alternate;
        }

        @keyframes talking {
            0% {
                height: 8px;
            }

            100% {
                height: 24px;
            }
        }

        @keyframes quiet {
            0% {
                height: 4px;
            }

            50% {
                height: 4px;
            }

            100% {
                height: 4px;
            }
        }

        .speaking .visualizer-bar:nth-child(1) {
            animation-delay: 0s;
        }

        .speaking .visualizer-bar:nth-child(2) {
            animation-delay: 0.1s;
        }

        .speaking .visualizer-bar:nth-child(3) {
            animation-delay: 0.2s;
        }

        /* Force Landscape Overlay */
        #landscape-overlay {
            display: none;
        }

        @media only screen and (min-device-width: 768px) and (max-device-width: 1024px) and (orientation: portrait) {
            #landscape-overlay {
                display: flex;
            }
        }
    </style>
</head>

<body class="bg-slate-50 h-[100dvh] w-full flex flex-col overflow-hidden">
    <!-- Landscape Warning Overlay -->
    <div id="landscape-overlay"
        class="fixed inset-0 z-[100] bg-slate-900 text-white flex-col items-center justify-center text-center p-10 animate-fade-in">
        <i class="fa-solid fa-rotate-left text-6xl mb-6 animate-pulse"></i>
        <h2 class="text-3xl font-black uppercase tracking-widest mb-4">Please Rotate Device</h2>
        <p class="text-lg text-gray-400 font-medium">This experience is optimized for Landscape mode.</p>
    </div>

    <!-- Header -->
    <header class="sticky-header h-16 shrink-0 px-4 flex justify-between items-center z-30">
        <div class="w-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" title="Back to Dashboard"
                    class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                    <i class="fa-solid fa-arrow-left text-sm"></i>
                </a>
                <h1 class="font-black text-gray-900 tracking-tight text-sm uppercase">AI Teacher</h1>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
                <button onclick="VoiceClone.toggleModal()" title="Clone Your Voice"
                    class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                    <i class="fa-solid fa-clone text-sm"></i>
                </button>
                <button onclick="Generator.copyRoomId()" title="Copy Room ID"
                    class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                    <i class="fa-regular fa-copy text-sm"></i>
                </button>
                <div class="relative group">
                    <button onclick="Generator.toggleQR()" title="Show QR Code"
                        class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                        <i class="fa-solid fa-qrcode text-sm"></i>
                    </button>
                    <!-- QR Dropdown -->
                    <div id="qr-dropdown"
                        class="absolute right-0 top-14 w-64 bg-white rounded-2xl shadow-apple border border-gray-100 p-6 hidden animate-fade-in z-50 flex flex-col items-center">
                        <div id="qrcode" class="mb-4 bg-white p-2 rounded-xl shadow-sm border border-gray-100"></div>
                        <button onclick="Generator.downloadQR()"
                            class="flex items-center gap-2 text-[10px] font-black text-[#0071e3] hover:text-[#0077ed] uppercase tracking-widest transition-colors py-2 px-4 rounded-full hover:bg-blue-50">
                            <i class="fa-solid fa-download"></i> Download QR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 p-1 md:p-2 w-full flex flex-col min-h-0">
        <div
            class="glass-apple rounded-[24px] md:rounded-[32px] p-6 md:p-10 flex-1 flex flex-col animate-slide-up w-full max-w-full mx-auto overflow-hidden shadow-2xl">
            <div class="flex-1 overflow-y-auto custom-scrollbar flex flex-col">
                <div class="mb-8 md:mb-12">
                    <div class="flex items-center gap-3 mb-2">
                        <div
                            class="w-8 h-8 md:w-10 md:h-10 rounded-lg md:rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                            <i class="fa-solid fa-wand-magic-sparkles text-sm md:text-base"></i>
                        </div>
                        <h2 class="text-2xl md:text-4xl font-black text-gray-900 tracking-tight">Generate Lesson</h2>
                    </div>
                    <p class="text-sm md:text-base text-gray-500 font-medium max-w-xl">Explain any topic
                        sentence-by-sentence to your class with human-like delivery and natural pacing.</p>
                </div>

                <div class="flex-1 w-full max-w-full mx-auto px-4 py-8 md:py-10 flex flex-col items-center">

                    <!-- Connection Status & Visualizer -->
                    <div id="status-badge"
                        class="mb-6 md:mb-8 px-5 py-2.5 bg-white text-gray-600 rounded-full text-xs font-bold uppercase tracking-widest border border-gray-200 flex items-center gap-3 shadow-sm transition-all duration-300">
                        <div class="flex items-center gap-1 h-5 visualizer opacity-50 transition-opacity">
                            <span class="visualizer-bar h-1 bg-blue-500"></span>
                            <span class="visualizer-bar h-1 bg-blue-500"></span>
                            <span class="visualizer-bar h-1 bg-blue-500"></span>
                        </div>
                        <span id="status-text">Connected to Classroom</span>
                    </div>

                    <div class="w-full space-y-6 md:space-y-10 flex-1">
                        <label
                            class="block text-[11px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">Subject
                            /
                            Topic</label>

                        <!-- Presets ScrollView -->
                        <div class="flex gap-2 mb-3 overflow-x-auto pb-2 custom-scrollbar -mx-1 px-1">
                            <button onclick="Generator.setTopic('Construction Safety Officer Duties')"
                                class="whitespace-nowrap px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-full text-sm font-bold transition-colors border border-blue-100/50">
                                üë∑ Safety Officer
                            </button>
                            <button onclick="Generator.setTopic('Proper Harness Usage & Inspection')"
                                class="whitespace-nowrap px-4 py-2 bg-orange-50 hover:bg-orange-100 text-orange-600 rounded-full text-sm font-bold transition-colors border border-orange-100/50">
                                ü™ù Harness Safety
                            </button>
                            <button onclick="Generator.setTopic('Complete PPE Guidelines')"
                                class="whitespace-nowrap px-4 py-2 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold transition-colors border border-yellow-100/50">
                                ‚õëÔ∏è PPE Rules
                            </button>
                            <button onclick="Generator.setTopic('Identifying Site Hazards')"
                                class="whitespace-nowrap px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-full text-sm font-bold transition-colors border border-red-100/50">
                                ‚ö†Ô∏è Site Hazards
                            </button>
                            <button onclick="Generator.setTopic('Emergency First Aid Response')"
                                class="whitespace-nowrap px-4 py-2 bg-green-50 hover:bg-green-100 text-green-600 rounded-full text-sm font-bold transition-colors border border-green-100/50">
                                üöë First Aid
                            </button>
                        </div>

                        <textarea id="topic-input" rows="4"
                            class="input-apple w-full px-5 py-4 md:px-7 md:py-6 text-gray-900 outline-none placeholder:text-gray-300 resize-none text-[16px] md:text-[18px]"
                            placeholder="e.g. How photosynthesis works, or the history of the Roman Empire..."></textarea>
                    </div>

                    <div class="flex gap-4 max-w-3xl">
                        <button id="start-btn" onclick="Generator.start()" title="Generate Lesson"
                            class="flex-1 group relative overflow-hidden rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 p-[2px] shadow-lg shadow-blue-500/30 transition-all hover:scale-[1.02] hover:shadow-blue-500/50 active:scale-[0.98]">
                            <div
                                class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90">
                                <i class="fa-solid fa-wand-magic-sparkles text-xl drop-shadow-sm"></i>
                                <span
                                    class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Generate
                                    Lesson</span>
                            </div>
                        </button>

                        <button id="broadcast-btn" onclick="Generator.startBroadcast()" title="Start Broadcast"
                            class="hidden flex-1 group relative overflow-hidden rounded-2xl bg-gradient-to-r from-emerald-500 to-emerald-600 p-[2px] shadow-lg shadow-emerald-500/30 transition-all hover:scale-[1.02] hover:shadow-emerald-500/50 active:scale-[0.98]">
                            <div
                                class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-emerald-500 to-emerald-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90">
                                <i class="fa-solid fa-tower-broadcast text-xl drop-shadow-sm animate-pulse"></i>
                                <span
                                    class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Start
                                    Broadcast</span>
                            </div>
                        </button>

                        <button id="stop-btn" onclick="Generator.stop()" title="Stop Lesson"
                            class="hidden group relative overflow-hidden rounded-2xl bg-gradient-to-r from-red-500 to-red-600 p-[2px] shadow-lg shadow-red-500/30 transition-all hover:scale-[1.02] hover:shadow-red-500/50 active:scale-[0.98]">
                            <div
                                class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-red-500 to-red-600 px-10 py-4 md:py-5 text-white transition-all">
                                <span
                                    class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">STOP</span>
                            </div>
                        </button>
                    </div>

                    <div id="log" class="space-y-3 pb-4">
                        <!-- Log entries -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Voice Clone Modal -->
    <div id="voice-clone-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="VoiceClone.toggleModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto">
            <div class="glass-apple rounded-2xl p-6 shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-black text-gray-900">Clone Your Voice</h3>
                    <button onclick="VoiceClone.toggleModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all">
                        <i class="fa-solid fa-times text-sm"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <p class="text-sm text-gray-600">Record or upload a 10-second audio sample to create your AI voice clone.</p>
                    
                    <!-- Voice Status -->
                    <div id="voice-status" class="hidden p-3 rounded-lg text-sm font-medium">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-check-circle text-green-500"></i>
                            <span>Voice clone ready!</span>
                        </div>
                    </div>

                    <!-- Recording Option -->
                    <div class="border border-gray-200 rounded-xl p-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Record Audio</h4>
                        <div class="flex items-center gap-3">
                            <button id="record-btn" onclick="VoiceClone.toggleRecording()" class="flex-1 bg-red-500 hover:bg-red-600 text-white rounded-xl py-3 px-4 font-medium transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-microphone"></i>
                                <span id="record-text">Start Recording</span>
                            </button>
                            <div id="record-timer" class="text-sm font-mono text-gray-600 hidden">00:00</div>
                        </div>
                        <div id="audio-visualizer" class="mt-3 h-12 bg-gray-100 rounded-lg flex items-center justify-center gap-1 hidden">
                            <div class="w-1 bg-blue-500 rounded-full animate-pulse"></div>
                            <div class="w-1 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.1s"></div>
                            <div class="w-1 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-1 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.3s"></div>
                            <div class="w-1 bg-blue-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>

                    <!-- Upload Option -->
                    <div class="border border-gray-200 rounded-xl p-4">
                        <h4 class="font-semibold text-gray-900 mb-3">Upload Audio File</h4>
                        <input type="file" id="audio-upload" accept="audio/*" class="hidden" onchange="VoiceClone.handleFileUpload(event)">
                        <button onclick="document.getElementById('audio-upload').click()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl py-3 px-4 font-medium transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-upload"></i>
                            <span>Choose Audio File</span>
                        </button>
                        <div id="upload-filename" class="mt-2 text-sm text-gray-600 hidden"></div>
                    </div>

                    <!-- Clone Button -->
                    <button id="clone-btn" onclick="VoiceClone.cloneVoice()" disabled class="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-xl py-3 px-4 font-medium transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-clone"></i>
                        <span>Create Voice Clone</span>
                    </button>

                    <!-- Progress -->
                    <div id="clone-progress" class="hidden">
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span id="progress-text" class="text-sm text-gray-600">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const CONFIG = {
            API_KEY: "sk-RPKYynytRIODIzGGm0GYgEF7RMgQqlee9upYDni5Yoi9gtLe",
            MOONSHOT_URL: "https://api.moonshot.ai/v1/chat/completions",
            CARTESIA_API_KEY: "sk_car_mD3uos1Gw5t4vefQFdfBDX", // Cartesia API key
            FIREBASE: {
                apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
                authDomain: "macx-5feca.firebaseapp.com",
                databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "macx-5feca",
                storageBucket: "macx-5feca.appspot.com"
            }
        };

        const Generator = {
            isActive: false,
            queue: [],
            interval: null,
            db: null,
            session: JSON.parse(localStorage.getItem('orbit_session') || '{}'),

            init() {
                const app = initializeApp(CONFIG.FIREBASE);
                this.db = getDatabase(app);
                if (!this.session.room) {
                    alert("No active session found. Please login via index.html first.");
                    window.location.href = 'index.html';
                    return;
                }
                window.Generator = this;

                // Initialize QR Code
                setTimeout(() => {
                    this.generateQR();
                }, 500);
            },

            generateQR() {
                const studentUrl = window.location.href.replace('teacher-ai.html', 'index.html') + '?room=' + this.session.room;
                const qrContainer = document.getElementById("qrcode");
                qrContainer.innerHTML = ""; // Clear existing
                new QRCode(qrContainer, {
                    text: studentUrl,
                    width: 160,
                    height: 160,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            },

            toggleQR() {
                const dropdown = document.getElementById('qr-dropdown');
                dropdown.classList.toggle('hidden');
            },

            downloadQR() {
                const qrCanvas = document.querySelector('#qrcode canvas');
                if (!qrCanvas) return;

                const link = document.createElement('a');
                link.download = `succes-class-qr-${this.session.room}.png`;
                link.href = qrCanvas.toDataURL();
                link.click();
            },

            copyRoomId() {
                navigator.clipboard.writeText(this.session.room).then(() => {
                    this.log(`Room ID ${this.session.room} copied to clipboard!`, "success");
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            },

            async start() {
                const input = document.getElementById('topic-input');
                const topic = input.value.trim();
                if (!topic) return;

                this.isActive = true;
                this.updateUI('generating');
                this.log("Generating lesson content for: " + topic, "info");

                try {
                    const response = await this.callAI(topic);
                    const ssmlBlock = response.choices[0].message.content;
                    const sentences = this.splitSSML(ssmlBlock);

                    this.queue = sentences;
                    this.log(`Generation complete! ${sentences.length} sentences ready.`, "success");
                    this.updateUI('ready');

                } catch (e) {
                    this.log("Error: " + e.message, "error");
                    this.stop();
                }
            },

            startBroadcast() {
                this.log("Starting live broadcast...", "success");
                this.updateUI('broadcasting');
                this.runLoop();
            },

            setTopic(topic) {
                const input = document.getElementById('topic-input');
                input.value = topic;
                input.focus();
            },

            stop() {
                this.isActive = false;
                if (this.interval) clearTimeout(this.interval);
                this.queue = [];
                this.releaseKeepAlive();
                this.updateUI('idle');
                this.log("Lesson stopped.", "warning");
            },

            async callAI(topic) {
                const systemPrompt = `You are "LiveClass Composer": a well-researched expert teacher who speaks naturally, but writes in a translation-stable way.

GOAL
Generate spoken teaching text for a live class or tutorial based on a structured request. The output must sound human and engaging, yet be easy to translate without meaning drift.

OUTPUT
Return ONLY raw string of valid SSML (no JSON, no headings, no bullet points, no preamble).
Use short paragraphs (1‚Äì2 sentences each). Keep the cadence like a real teacher.

TRANSLATION-STABLE WRITING RULES (NON-NEGOTIABLE)
1) NO idioms, NO puns, NO culture-specific sayings, NO metaphors that require interpretation.
2) Prefer concrete nouns over pronouns (repeat the noun if needed). Avoid unclear ‚Äúit/they/this/that‚Äù.
3) Keep sentences short (8‚Äì18 words). One idea per sentence.
4) Avoid sarcasm that relies on tone. If humor is used, make it explicit and literal.
5) Keep technical terms consistent. Do not rename the same concept later.
6) Keep numbers, units, and proper nouns unchanged.
7) If you add a joke, it must still be literally correct when translated.

CARTESIA SSML RULES (STRICT & CRITICAL)
- Output MUST be valid SSML only.
- Use <break time="300ms"/> to <break time="800ms"/> for natural thinking pauses.
- Do NOT describe emotions in text ‚Äî express them through pacing and delivery.
- Do NOT include explanations about SSML.
- Do NOT include markdown, code fences, or metadata.
- Wrap everything in a single <speak> tag.
- Vary sentence length: some short, some flowing to sound human.
- Occasionally repeat a word once for realism (e.g., ‚Äúso, so this part is important‚Äù).
- Use light verbal fillers appropriate to the target language (e.g., ‚Äúuh‚Äù, ‚Äúum‚Äù).

LANGUAGE LOCK (CRITICAL)
- The variable TEACHER_LANGUAGE defines your language.
- Every word, filler, hesitation, and explanation MUST be in ${this.session.lang || 'English'}.
- If TEACHER_LANGUAGE = Dutch (nl-BE), you speak natural Belgian Dutch.
- If TEACHER_LANGUAGE = English, you speak natural conversational English.
- Never mix languages unless that language itself is mixed.

STRUCTURE
1) Hook (2 sentences)
2) Core explanation (6‚Äì10 sentences)
3) One brief student question moment (literal pattern: "Okay, quick question from a student: <question>.")
4) Practical example (3‚Äì5 sentences)
5) Wrap-up + invitation for questions (2‚Äì3 sentences)

SAFETY / TONE
Keep it classroom-safe. No explicit sexual content. No self-harm content. No hate. No illegal instructions.

QUALITY BAR
Sound like a real teacher thinking aloud: allow small fillers like ‚Äúum‚Äù, ‚Äúokay‚Äù, ‚Äúright‚Äù, but keep them rare (max 6 total).
Be specific, accurate, and clear.`;

                const res = await fetch(CONFIG.MOONSHOT_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "kimi-k2-0711-preview",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Please explain this topic: ${topic}` }
                        ],
                        temperature: 0.7
                    })
                });

                if (!res.ok) throw new Error("Moonshot API failed: " + res.statusText);
                return res.json();
            },

            initKeepAlive() {
                // 1. Wake Lock
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen')
                        .then(lock => { this.wakeLock = lock; })
                        .catch(e => console.log('Wake Lock Error:', e));
                }

                // 2. Silent Audio Hack for Background Execution
                if (!this.silentAudio) {
                    this.silentAudio = new Audio();
                    // 1s of silence base64
                    this.silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA';
                    this.silentAudio.loop = true;
                    this.silentAudio.volume = 0; // Silent
                }
                this.silentAudio.play().catch(() => { });
            },

            releaseKeepAlive() {
                if (this.wakeLock) {
                    this.wakeLock.release().then(() => { this.wakeLock = null; });
                }
                if (this.silentAudio) {
                    this.silentAudio.pause();
                }
            },

            splitSSML(ssml) {
                // Remove outer <speak> tags if present to split content
                let content = ssml.replace(/<\/?speak>/g, '').trim();

                // Split by common sentence endings, but try to keep <break/> tags attached to previous sentence
                // We'll use a regex that matches sentence endings followed by whitespace or end of string, 
                // but doesn't split if it's part of a tag (very basic heuristic)
                const segments = content.split(/(?<=[.!?])\s+(?![^<]*>)/g);

                return segments.filter(s => s.trim().length > 0).map(s => {
                    // Wrap back in speak tag
                    return `<speak>${s.trim()}</speak>`;
                });
            },

            runLoop() {
                if (this.interval) clearInterval(this.interval);

                // Random delay between 3000ms and 4000ms
                const delay = Math.floor(Math.random() * 1000) + 3000;

                // Start Keep-Alive (WakeLock + Audio)
                this.initKeepAlive();

                this.interval = setTimeout(() => {
                    if (!this.isActive || this.queue.length === 0) {
                        this.stop();
                        return;
                    }

                    const sentence = this.queue.shift();
                    this.broadcast(sentence);

                    // Recursive call for next sentence
                    this.runLoop();
                }, delay);
            },

            broadcast(ssml) {
                // Strip tags for display text
                const text = ssml.replace(/<[^>]*>/g, '').trim();

                // Check if user has a cloned voice
                const userVoiceId = VoiceClone.getUserVoiceId();

                push(ref(this.db, `chats/${this.session.room}/messages`), {
                    text: text,
                    ssml: ssml, // Send the full SSML for TTS
                    lang: this.session.lang,
                    senderName: "AI Teacher",
                    senderId: "ai-generator",
                    timestamp: Date.now(),
                    voiceId: userVoiceId || null // Include cloned voice ID if available
                });

                this.logLatency(`Sent: ${text.substring(0, 20)}...`);
                this.logLatency(`Sent: ${text.substring(0, 20)}...`);
                this.log(`Sent: ${text.substring(0, 50)}...`, "info");
            },

            logLatency(msg) {
                const now = new Date();
                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}`;
                const logEl = document.getElementById('latency-log');
                const entry = document.createElement('span');
                entry.innerText = `[${time}] ${msg}`;
                entry.className = "opacity-80 border-r border-white/20 pr-2 mr-2";

                // Prepend to show latest first? Or Append? User said "monitor latency... the moment it sends". 
                // Horizontal scroll usually implies append if reading left-to-right.
                logEl.appendChild(entry);

                // Auto scroll to end
                logEl.scrollLeft = logEl.scrollWidth;

                // Limit items
                if (logEl.children.length > 50) logEl.firstChild.remove();
            },

            updateUI(state) {
                const startBtn = document.getElementById('start-btn');
                const broadcastBtn = document.getElementById('broadcast-btn');
                const stopBtn = document.getElementById('stop-btn');
                const statusBadge = document.getElementById('status-badge');
                const statusText = document.getElementById('status-text');
                const input = document.getElementById('topic-input');
                const visualizer = statusBadge.querySelector('.visualizer');

                // Helper to set badge style
                const setBadge = (mode) => {
                    if (mode === 'live') {
                        statusBadge.classList.replace('border-gray-200', 'border-emerald-200');
                        statusBadge.classList.replace('bg-white', 'bg-emerald-50');
                        statusBadge.classList.replace('text-gray-600', 'text-emerald-700');
                        visualizer.classList.add('speaking');
                        visualizer.classList.remove('opacity-50');
                        statusText.textContent = "Live Broadcast Active";
                    } else {
                        statusBadge.classList.replace('border-emerald-200', 'border-gray-200');
                        statusBadge.classList.replace('bg-emerald-50', 'bg-white');
                        statusBadge.classList.replace('text-emerald-700', 'text-gray-600');
                        visualizer.classList.remove('speaking');
                        visualizer.classList.add('opacity-50');
                        statusText.textContent = "Connected to Classroom";
                    }
                };

                switch (state) {
                    case 'generating':
                        startBtn.classList.remove('hidden');
                        broadcastBtn.classList.add('hidden');
                        stopBtn.classList.add('hidden');
                        startBtn.disabled = true;
                        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        startBtn.innerHTML = '<div class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all"><i class="fa-solid fa-circle-notch fa-spin text-xl"></i><span class="text-sm md:text-base font-black tracking-widest uppercase">Planning...</span></div>';
                        input.disabled = true;
                        setBadge('idle');
                        break;

                    case 'ready':
                        startBtn.classList.add('hidden');
                        broadcastBtn.classList.remove('hidden');
                        stopBtn.classList.add('hidden');
                        input.disabled = true;
                        this.log("Review correct? Click BROADCAST to start.", "info");
                        setBadge('idle');
                        break;

                    case 'broadcasting':
                        startBtn.classList.add('hidden');
                        broadcastBtn.classList.add('hidden');
                        stopBtn.classList.remove('hidden');
                        input.disabled = true;
                        setBadge('live');
                        break;

                    default: // idle
                        startBtn.classList.remove('hidden');
                        broadcastBtn.classList.add('hidden');
                        stopBtn.classList.add('hidden');
                        startBtn.disabled = false;
                        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        startBtn.innerHTML = '<div class="relative flex h-full items-center justify-center gap-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-4 md:py-5 text-white transition-all group-hover:bg-opacity-90"><i class="fa-solid fa-wand-magic-sparkles text-xl drop-shadow-sm"></i><span class="text-sm md:text-base font-black tracking-widest uppercase text-white drop-shadow-sm">Generate Lesson</span></div>';
                        input.disabled = false;
                        setBadge('idle');
                }
            },

            logLatency(msg) {
                const now = new Date();
                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}.${now.getMilliseconds().toString().padStart(3, '0')}`;
                const logEl = document.getElementById('latency-log');
                if (!logEl) return;

                const entry = document.createElement('span');
                entry.innerText = `[${time}] ${msg}`;
                entry.className = "opacity-80 border-r border-white/20 pr-2 mr-2";

                logEl.appendChild(entry);
                logEl.scrollLeft = logEl.scrollWidth;
                if (logEl.children.length > 50) logEl.firstChild.remove();
            },


            log(msg, type) {
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl text-xs font-medium animate-slide-up ${type === 'success' ? 'bg-green-50 text-green-700' :
                    type === 'error' ? 'bg-red-50 text-red-700' :
                        type === 'warning' ? 'bg-yellow-50 text-yellow-700' :
                            'bg-blue-50 text-blue-700'
                    }`;
                div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
                const container = document.getElementById('log');
                container.prepend(div);
            }
        };

        const VoiceClone = {
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            audioBlob: null,
            recordingStartTime: null,
            recordingTimer: null,
            maxRecordingTime: 10000, // 10 seconds

            async init() {
                // Request microphone permissions
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (error) {
                    console.error('Microphone access denied:', error);
                }
            },

            toggleModal() {
                const modal = document.getElementById('voice-clone-modal');
                modal.classList.toggle('hidden');
                
                // Check if user already has a voice clone when opening
                if (!modal.classList.contains('hidden') && this.hasUserVoice()) {
                    this.showVoiceStatus(true);
                }
            },

            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            },

            async startRecording() {
                try {
                    console.log('Requesting microphone access...');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        } 
                    });
                    
                    console.log('Microphone access granted');
                    console.log('Stream active:', stream.active);
                    console.log('Audio tracks:', stream.getAudioTracks().length);

                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/wav'
                    });
                    this.audioChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        console.log('Data available:', event.data.size, 'bytes');
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        console.log('Recording stopped');
                        console.log('Audio chunks collected:', this.audioChunks.length);
                        
                        if (this.audioChunks.length > 0) {
                            this.audioBlob = new Blob(this.audioChunks, { 
                                type: this.mediaRecorder.mimeType || 'audio/webm' 
                            });
                            console.log('Audio blob created:', this.audioBlob.size, 'bytes');
                            console.log('Audio blob type:', this.audioBlob.type);
                            this.enableCloneButton();
                        } else {
                            console.error('No audio data recorded');
                            alert('No audio data recorded. Please try again.');
                        }
                        
                        this.updateRecordingUI(false);
                        
                        // Clean up stream
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        alert('Recording error: ' + event.error.message);
                        this.updateRecordingUI(false);
                        stream.getTracks().forEach(track => track.stop());
                    };

                    this.mediaRecorder.start(100); // Collect data every 100ms
                    this.isRecording = true;
                    this.recordingStartTime = Date.now();
                    this.updateRecordingUI(true);
                    this.startRecordingTimer();

                    console.log('Recording started');

                    // Auto-stop after 10 seconds
                    setTimeout(() => {
                        if (this.isRecording) {
                            console.log('Auto-stopping recording after 10 seconds');
                            this.stopRecording();
                        }
                    }, this.maxRecordingTime);

                } catch (error) {
                    console.error('Error starting recording:', error);
                    alert('Could not access microphone: ' + error.message + '. Please check permissions.');
                    this.updateRecordingUI(false);
                }
            },

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    this.isRecording = false;
                    this.stopRecordingTimer();
                }
            },

            startRecordingTimer() {
                const timerEl = document.getElementById('record-timer');
                const textEl = document.getElementById('record-text');
                
                timerEl.classList.remove('hidden');
                textEl.textContent = 'Stop Recording';
                
                this.recordingTimer = setInterval(() => {
                    const elapsed = Date.now() - this.recordingStartTime;
                    const seconds = Math.floor(elapsed / 1000);
                    const milliseconds = Math.floor((elapsed % 1000) / 100);
                    timerEl.textContent = `00:${seconds.toString().padStart(2, '0')}.${milliseconds}`;
                }, 100);
            },

            stopRecordingTimer() {
                if (this.recordingTimer) {
                    clearInterval(this.recordingTimer);
                    this.recordingTimer = null;
                }
                document.getElementById('record-timer').classList.add('hidden');
                document.getElementById('record-text').textContent = 'Start Recording';
            },

            updateRecordingUI(isRecording) {
                const recordBtn = document.getElementById('record-btn');
                const visualizer = document.getElementById('audio-visualizer');
                
                if (isRecording) {
                    recordBtn.classList.replace('bg-red-500', 'bg-red-600');
                    recordBtn.classList.replace('hover:bg-red-600', 'hover:bg-red-700');
                    visualizer.classList.remove('hidden');
                } else {
                    recordBtn.classList.replace('bg-red-600', 'bg-red-500');
                    recordBtn.classList.replace('hover:bg-red-700', 'hover:bg-red-600');
                    visualizer.classList.add('hidden');
                }
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File size must be less than 10MB');
                        return;
                    }

                    // Check file type
                    if (!file.type.startsWith('audio/')) {
                        alert('Please select an audio file');
                        return;
                    }

                    this.audioBlob = file;
                    document.getElementById('upload-filename').textContent = `Selected: ${file.name}`;
                    document.getElementById('upload-filename').classList.remove('hidden');
                    this.enableCloneButton();
                }
            },

            enableCloneButton() {
                document.getElementById('clone-btn').disabled = false;
            },

            async cloneVoice() {
                if (!this.audioBlob) {
                    alert('Please record or upload audio first');
                    return;
                }

                const cloneBtn = document.getElementById('clone-btn');
                const progressDiv = document.getElementById('clone-progress');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');

                cloneBtn.disabled = true;
                cloneBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>Cloning...</span>';
                progressDiv.classList.remove('hidden');

                try {
                    console.log('Starting voice cloning process...');
                    console.log('Audio blob size:', this.audioBlob.size);
                    console.log('Audio blob type:', this.audioBlob.type);
                    
                    // Update progress
                    progressBar.style.width = '20%';
                    progressText.textContent = '20%';

                    // Convert blob to base64 (remove data URL prefix)
                    const base64Audio = await this.blobToBase64(this.audioBlob);
                    const cleanBase64 = base64Audio.split(',')[1]; // Remove "data:audio/wav;base64," prefix
                    
                    console.log('Base64 audio length:', cleanBase64.length);
                    
                    // Update progress
                    progressBar.style.width = '40%';
                    progressText.textContent = '40%';

                    // Call Cartesia API to create voice clone
                    const voiceId = await this.createCartesiaVoice(cleanBase64);
                    
                    console.log('Voice created with ID:', voiceId);
                    
                    // Update progress
                    progressBar.style.width = '80%';
                    progressText.textContent = '80%';

                    // Store voice ID
                    localStorage.setItem('user_voice_id', voiceId);
                    localStorage.setItem('user_voice_created', Date.now().toString());
                    
                    console.log('Voice ID stored in localStorage');
                    
                    // Complete
                    progressBar.style.width = '100%';
                    progressText.textContent = '100%';

                    // Show success
                    setTimeout(() => {
                        this.showVoiceStatus(true);
                        cloneBtn.innerHTML = '<i class="fa-solid fa-check"></i> <span>Voice Cloned!</span>';
                        cloneBtn.classList.replace('bg-blue-500', 'bg-green-500');
                        cloneBtn.classList.replace('hover:bg-blue-600', 'hover:bg-green-600');
                        
                        alert('Voice cloning successful! Your voice will now be used for translations.');
                        
                        setTimeout(() => {
                            this.toggleModal();
                        }, 2000);
                    }, 500);

                } catch (error) {
                    console.error('Voice cloning failed:', error);
                    console.error('Error details:', error.message);
                    
                    // Show detailed error
                    alert(`Voice cloning failed: ${error.message}. Please check your API key and try again.`);
                    
                    cloneBtn.disabled = false;
                    cloneBtn.innerHTML = '<i class="fa-solid fa-clone"></i> <span>Create Voice Clone</span>';
                }

                progressDiv.classList.add('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
            },

            async createCartesiaVoice(base64Audio) {
                console.log('Calling Cartesia API...');
                
                // Use hardcoded API key from CONFIG
                const apiKey = CONFIG.CARTESIA_API_KEY;
                
                console.log('API Key present:', !!apiKey);
                console.log('API Key starts with sk_car:', apiKey?.startsWith('sk_car'));
                
                // Check if API key is properly set
                if (!apiKey || !apiKey.startsWith('sk_car')) {
                    throw new Error('Cartesia API key is not configured properly');
                }

                // Cartesia API endpoint for voice cloning
                const response = await fetch('https://api.cartesia.ai/voices', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'Cartesia-Version': '2024-06-10'
                    },
                    body: JSON.stringify({
                        name: `User Voice ${new Date().toISOString()}`,
                        description: 'Cloned voice for AI Teacher translation',
                        embedding: {
                            data: base64Audio,
                            format: 'webm' // Use webm format since we record in webm
                        },
                        language: Generator.session.lang || 'en'
                    })
                });

                console.log('Cartesia API response status:', response.status);
                console.log('Cartesia API response headers:', response.headers);

                const responseText = await response.text();
                console.log('Cartesia API response:', responseText);

                if (!response.ok) {
                    throw new Error(`Cartesia API error: ${response.status} ${response.statusText} - ${responseText}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Failed to parse Cartesia response: ${parseError.message}. Response: ${responseText}`);
                }

                if (!data.id) {
                    throw new Error(`No voice ID returned from Cartesia. Response: ${JSON.stringify(data)}`);
                }

                return data.id; // Return the voice ID
            },

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            },

            showVoiceStatus(hasVoice) {
                const statusEl = document.getElementById('voice-status');
                if (hasVoice) {
                    statusEl.classList.remove('hidden');
                    statusEl.classList.add('bg-green-50', 'text-green-700');
                } else {
                    statusEl.classList.add('hidden');
                }
            },

            getUserVoiceId() {
                return localStorage.getItem('user_voice_id');
            },

            hasUserVoice() {
                return !!this.getUserVoiceId();
            }
        };

        // Initialize VoiceClone
        VoiceClone.init();
        window.VoiceClone = VoiceClone;

        Generator.init();
    </script>
    <!-- Latency Monitor Log -->
    <div id="latency-log"
        class="fixed bottom-0 left-0 w-full h-auto max-h-[24px] bg-black/90 text-green-400 text-[8px] font-mono leading-none flex items-center gap-4 px-2 overflow-x-auto whitespace-nowrap z-[9999] pointer-events-none">
    </div>
</body>

</html>