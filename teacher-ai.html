<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Generator - Succes Class</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.88);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-blur: blur(16px);
            --shadow-apple: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #fbfbfd;
            height: 100dvh;
            overflow: hidden;
            color: #1d1d1f;
            letter-spacing: -0.022em;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .font-black {
            font-family: "SF Pro Display", "SF Pro Text", -apple-system, sans-serif;
            letter-spacing: -0.02em;
        }

        .glass-apple {
            background: var(--glass-bg);
            -webkit-backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            border: 0.5px solid var(--glass-border);
            box-shadow: var(--shadow-apple);
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.8);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
        }

        .bottom-lift {
            padding-bottom: calc(25px + env(safe-area-inset-bottom));
        }

        .input-apple {
            background: #f5f5f7;
            border: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .input-apple:focus {
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 125, 250, 0.1);
            outline: none;
        }

        .btn-apple {
            border-radius: 14px;
            font-weight: 510;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .btn-apple:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .animate-slide-up {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="sticky-header h-16 px-6 flex justify-between items-center z-30">
        <div class="px-2 max-w-7xl mx-auto w-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" title="Back to Dashboard"
                    class="w-10 h-10 rounded-full bg-[#f5f5f7] flex items-center justify-center text-gray-500 hover:text-gray-900 transition-all active:scale-95">
                    <i class="fa-solid fa-arrow-left text-sm"></i>
                </a>
                <h1 class="font-black text-gray-900 tracking-tight text-sm uppercase">AI Teacher</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="status-badge"
                    class="hidden flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 text-[#0071e3] text-[10px] font-black uppercase tracking-wider animate-pulse">
                    <i class="fa-solid fa-brain"></i> Teaching
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 p-6 md:p-12 max-w-full lg:max-w-screen-xl mx-auto w-full flex flex-col">
        <div
            class="glass-apple rounded-[32px] md:rounded-[48px] p-8 md:p-12 flex-1 flex flex-col animate-slide-up h-full">
            <div class="mb-8 md:mb-12">
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="w-8 h-8 md:w-10 md:h-10 rounded-lg md:rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                        <i class="fa-solid fa-wand-magic-sparkles text-sm md:text-base"></i>
                    </div>
                    <h2 class="text-2xl md:text-4xl font-black text-gray-900 tracking-tight">Generate Lesson</h2>
                </div>
                <p class="text-sm md:text-base text-gray-500 font-medium max-w-xl">Explain any topic
                    sentence-by-sentence to your class with human-like delivery and natural pacing.</p>
            </div>

            <div class="space-y-6 md:space-y-10 flex-1">
                <div class="max-w-3xl">
                    <label
                        class="block text-[11px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">Subject /
                        Topic</label>

                    <!-- Presets ScrollView -->
                    <div class="flex gap-2 mb-3 overflow-x-auto pb-2 custom-scrollbar -mx-1 px-1">
                        <button onclick="Generator.setTopic('Construction Safety Officer Duties')"
                            class="whitespace-nowrap px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-full text-sm font-bold transition-colors border border-blue-100/50">
                            üë∑ Safety Officer
                        </button>
                        <button onclick="Generator.setTopic('Proper Harness Usage & Inspection')"
                            class="whitespace-nowrap px-4 py-2 bg-orange-50 hover:bg-orange-100 text-orange-600 rounded-full text-sm font-bold transition-colors border border-orange-100/50">
                            ü™ù Harness Safety
                        </button>
                        <button onclick="Generator.setTopic('Complete PPE Guidelines')"
                            class="whitespace-nowrap px-4 py-2 bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold transition-colors border border-yellow-100/50">
                            ‚õëÔ∏è PPE Rules
                        </button>
                        <button onclick="Generator.setTopic('Identifying Site Hazards')"
                            class="whitespace-nowrap px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-full text-sm font-bold transition-colors border border-red-100/50">
                            ‚ö†Ô∏è Site Hazards
                        </button>
                        <button onclick="Generator.setTopic('Emergency First Aid Response')"
                            class="whitespace-nowrap px-4 py-2 bg-green-50 hover:bg-green-100 text-green-600 rounded-full text-sm font-bold transition-colors border border-green-100/50">
                            üöë First Aid
                        </button>
                    </div>

                    <textarea id="topic-input" rows="4"
                        class="input-apple w-full px-5 py-4 md:px-7 md:py-6 text-gray-900 outline-none placeholder:text-gray-300 resize-none text-[16px] md:text-[18px]"
                        placeholder="e.g. How photosynthesis works, or the history of the Roman Empire..."></textarea>
                </div>

                <div class="flex gap-4 max-w-3xl">
                    <button id="start-btn" onclick="Generator.start()" title="Start Lesson"
                        class="flex-1 btn-apple bg-[#0071e3] hover:bg-[#0077ed] text-white py-4 md:py-5 shadow-lg shadow-blue-500/10 flex items-center justify-center gap-3 text-lg md:text-xl">
                        <i class="fa-solid fa-play"></i> START
                    </button>
                    <button id="stop-btn" onclick="Generator.stop()" title="Stop Lesson"
                        class="hidden btn-apple bg-[#ff3b30] hover:bg-[#ff453a] text-white px-8 py-4 md:py-5 shadow-lg shadow-red-500/10 transition-all text-lg md:text-xl">
                        STOP
                    </button>
                </div>

                <div id="log" class="space-y-3 overflow-y-auto max-h-[30vh] md:max-h-[40vh] custom-scrollbar pb-10">
                    <!-- Log entries -->
                </div>
            </div>
        </div>
        <div class="bottom-lift"></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const CONFIG = {
            API_KEY: "sk-RPKYynytRIODIzGGm0GYgEF7RMgQqlee9upYDni5Yoi9gtLe",
            MOONSHOT_URL: "https://api.moonshot.ai/v1/chat/completions",
            FIREBASE: {
                apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
                authDomain: "macx-5feca.firebaseapp.com",
                databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "macx-5feca",
                storageBucket: "macx-5feca.appspot.com"
            }
        };

        const Generator = {
            isActive: false,
            queue: [],
            interval: null,
            db: null,
            session: JSON.parse(localStorage.getItem('orbit_session') || '{}'),

            init() {
                const app = initializeApp(CONFIG.FIREBASE);
                this.db = getDatabase(app);
                if (!this.session.room) {
                    alert("No active session found. Please login via index.html first.");
                    window.location.href = 'index.html';
                    return;
                }
                window.Generator = this;
            },

            async start() {
                const input = document.getElementById('topic-input');
                const topic = input.value.trim();
                if (!topic) return;

                this.isActive = true;
                this.updateUI(true);
                this.log("Starting generation for: " + topic, "info");

                try {
                    const response = await this.callAI(topic);
                    const ssmlBlock = response.choices[0].message.content;

                    // Split into sentences using a simple regex that respects SSML tags
                    // We look for patterns like . or ! or ? that are NOT followed by a tag closing but might be followed by whitespace
                    // A better way is to split by broad sentence boundaries and re-wrap
                    const sentences = this.splitSSML(ssmlBlock);

                    this.log(`Generated ${sentences.length} sentences. Starting broadcast...`, "success");
                    this.queue = sentences;
                    this.runLoop();

                } catch (e) {
                    this.log("Error: " + e.message, "error");
                    this.stop();
                }
            },

            setTopic(topic) {
                const input = document.getElementById('topic-input');
                input.value = topic;
                input.focus();
            },

            stop() {
                this.isActive = false;
                if (this.interval) clearInterval(this.interval);
                this.queue = [];
                this.updateUI(false);
                this.log("Lesson stopped.", "warning");
            },

            async callAI(topic) {
                const systemPrompt = `You are "LiveClass Composer": a well-researched expert teacher who speaks naturally, but writes in a translation-stable way.

GOAL
Generate spoken teaching text for a live class or tutorial based on a structured request. The output must sound human and engaging, yet be easy to translate without meaning drift.

OUTPUT
Return ONLY raw string of valid SSML (no JSON, no headings, no bullet points, no preamble).
Use short paragraphs (1‚Äì2 sentences each). Keep the cadence like a real teacher.

TRANSLATION-STABLE WRITING RULES (NON-NEGOTIABLE)
1) NO idioms, NO puns, NO culture-specific sayings, NO metaphors that require interpretation.
2) Prefer concrete nouns over pronouns (repeat the noun if needed). Avoid unclear ‚Äúit/they/this/that‚Äù.
3) Keep sentences short (8‚Äì18 words). One idea per sentence.
4) Avoid sarcasm that relies on tone. If humor is used, make it explicit and literal.
5) Keep technical terms consistent. Do not rename the same concept later.
6) Keep numbers, units, and proper nouns unchanged.
7) If you add a joke, it must still be literally correct when translated.

CARTESIA SSML RULES (STRICT & CRITICAL)
- Output MUST be valid SSML only.
- Use <break time="300ms"/> to <break time="800ms"/> for natural thinking pauses.
- Do NOT describe emotions in text ‚Äî express them through pacing and delivery.
- Do NOT include explanations about SSML.
- Do NOT include markdown, code fences, or metadata.
- Wrap everything in a single <speak> tag.
- Vary sentence length: some short, some flowing to sound human.
- Occasionally repeat a word once for realism (e.g., ‚Äúso, so this part is important‚Äù).
- Use light verbal fillers appropriate to the target language (e.g., ‚Äúuh‚Äù, ‚Äúum‚Äù).

LANGUAGE LOCK (CRITICAL)
- The variable TEACHER_LANGUAGE defines your language.
- Every word, filler, hesitation, and explanation MUST be in ${this.session.lang || 'English'}.
- If TEACHER_LANGUAGE = Dutch (nl-BE), you speak natural Belgian Dutch.
- If TEACHER_LANGUAGE = English, you speak natural conversational English.
- Never mix languages unless that language itself is mixed.

STRUCTURE
1) Hook (2 sentences)
2) Core explanation (6‚Äì10 sentences)
3) One brief student question moment (literal pattern: "Okay, quick question from a student: <question>.")
4) Practical example (3‚Äì5 sentences)
5) Wrap-up + invitation for questions (2‚Äì3 sentences)

SAFETY / TONE
Keep it classroom-safe. No explicit sexual content. No self-harm content. No hate. No illegal instructions.

QUALITY BAR
Sound like a real teacher thinking aloud: allow small fillers like ‚Äúum‚Äù, ‚Äúokay‚Äù, ‚Äúright‚Äù, but keep them rare (max 6 total).
Be specific, accurate, and clear.`;

                const res = await fetch(CONFIG.MOONSHOT_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "kimi-k2-0711-preview",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `Please explain this topic: ${topic}` }
                        ],
                        temperature: 0.7
                    })
                });

                if (!res.ok) throw new Error("Moonshot API failed: " + res.statusText);
                return res.json();
            },

            splitSSML(ssml) {
                // Remove outer <speak> tags if present to split content
                let content = ssml.replace(/<\/?speak>/g, '').trim();

                // Split by common sentence endings, but try to keep <break/> tags attached to previous sentence
                // We'll use a regex that matches sentence endings followed by whitespace or end of string, 
                // but doesn't split if it's part of a tag (very basic heuristic)
                const segments = content.split(/(?<=[.!?])\s+(?![^<]*>)/g);

                return segments.filter(s => s.trim().length > 0).map(s => {
                    // Wrap back in speak tag
                    return `<speak>${s.trim()}</speak>`;
                });
            },

            runLoop() {
                if (this.interval) clearInterval(this.interval);

                this.interval = setInterval(() => {
                    if (!this.isActive || this.queue.length === 0) {
                        this.stop();
                        return;
                    }

                    const sentence = this.queue.shift();
                    this.broadcast(sentence);
                }, 3000);
            },

            broadcast(ssml) {
                // Strip tags for display text
                const text = ssml.replace(/<[^>]*>/g, '').trim();

                push(ref(this.db, `chats/${this.session.room}/messages`), {
                    text: text,
                    ssml: ssml, // Send the full SSML for TTS
                    lang: this.session.lang,
                    senderName: "AI Teacher",
                    senderId: "ai-generator",
                    timestamp: Date.now()
                });

                this.log(`Sent: ${text.substring(0, 50)}...`, "info");
            },

            updateUI(active) {
                document.getElementById('start-btn').disabled = active;
                document.getElementById('start-btn').classList.toggle('opacity-50', active);
                document.getElementById('stop-btn').classList.toggle('hidden', !active);
                document.getElementById('status-badge').classList.toggle('hidden', !active);
                document.getElementById('topic-input').disabled = active;
            },

            log(msg, type) {
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl text-xs font-medium animate-slide-up ${type === 'success' ? 'bg-green-50 text-green-700' :
                    type === 'error' ? 'bg-red-50 text-red-700' :
                        type === 'warning' ? 'bg-yellow-50 text-yellow-700' :
                            'bg-blue-50 text-blue-700'
                    }`;
                div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
                const container = document.getElementById('log');
                container.prepend(div);
            }
        };

        Generator.init();
    </script>
</body>

</html>